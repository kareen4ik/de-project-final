  # Финальный проект (наконец выдыхаем)  
  Привет, ревьюер! Я — **Карина** из Data Engineering. У меня есть опыт работы продуктовым аналитиком в финтехе, поэтому задание оказалось не страшней `psycopg2.errors`. Ниже — что сделала, где лежит и почему это не разваливается.

  Наконец-то я на финише. Если честно, дошла до него на морально-волевых, курс перестал нравиться с 6-го спринта из-за бесконечных багов и инфраструктурных проблем.

  ---

  ## 0. Инфра Яндекса (боль)

  Самым неприятным был 7 спринт с самоуничтожающейся падающей инфраструктурой, он позади, как и этот курс. Сейчас проблема была с готовым Docker-образом и нехватка времени или лень пилить собственный. Проще было доработать имеющееся, чем строить с нуля.

  * Плюсы — Airflow, Metabase, Postgres уже подняты, порты расшарены, всем спасибо.  
  * Минусы — **нет** `python-dotenv`, `psycopg`, `vertica-python`.  
    Пришлось «мастеркейсую»:  
    ```bash
    docker exec de-final-prj-local pip install \
        python-dotenv psycopg vertica-python
    ```

  Я спрятала креды в .ENV, потому что, на мой взгляд, так и надо.

  Все чувствительные штуки (PG_*, VERTICA_*) — в .env, монтируется как volume:

  ```bash
  -v $(pwd)/.env:/opt/airflow/.env
  ```
  ## 1. Проверка данных на адекватность
  ### `transactions`

  ```sql
  SELECT 
      operation_id,
      COUNT(1) AS cnt
  FROM transactions
  GROUP BY 1
  HAVING COUNT(1) > 1
  ORDER BY 2 DESC;
  ```
  Результат ожидаемый – дубли, связанные со спецификой транзакций. Одна и та же операция перемещается по статусам, все движения фиксируются. В STAGING затащу как есть, но для витрины нужно будет вычистить по статусам.

  ### `currencies`

  ```sql
  SELECT 
      date_update::date,
      currency_code,
      currency_code_with,
      COUNT(1) AS cnt
  FROM currencies
  GROUP BY 1,2,3
  HAVING COUNT(1) > 1;
  ```

  Курсы ведут себя прилично, на комбинацию «дата + валюта» запись ровно одна

  ## 2. Классы и DAG

  ### 2.1. `lib/pg_connect.py`  
  Небольшая утилита, которая читает креды из `.env` и превращает их в готовую строку подключения.  

  ### 2.2 StgTransactionsLoader

  Класс в src/py/stg_transactions_loader.py отвечает за всё, что связано с таблицей STAGING.Аналогично stg_currencies_loader.py 

  SELECT из продовой Postgres, берём всё как есть, даже с дублями.

  io.StringIO() + csv.writer: собираем всё в строковый буфер

  ```python
  buf = io.StringIO()
  writer = csv.writer(buf)
  writer.writerows(rows)
  buf.seek(0)
  COPY ... FROM STDIN в Vertica
  ```
  отрабатывает гораздо быстрее, чем INSERT (коннект к Вертике упал, пришлось искать альтернативное решение).

  ### 2.3 DWHGlobalMetricsLoader 
  Для расчёта финальной витрины в src/py/dwh_global_metrics_loader.py:

  CTE last_tx — оставляем только последнюю строку по каждому operation_id.
  CTE agg — агрегируем суммы (плюс done, минус chargeback), пересчитываем в USD.

  DELETE … WHERE (date_update, currency_from) IN (SELECT … FROM agg)

  INSERT INTO global_metrics SELECT * FROM agg

  ### 2.4 DAG
  А тут ждал сюрприз от Docker-образа Яндекса: 

  bash```
  docker exec -it de-final-prj-local /bin/sh -lc "
    airflow config get-value core dags_folder
  "
  ```
  Airflow ждал DAG по адресу lessons/dags. Чтобы указать нужную папку, перезапустила образ, указала нужный путь:
  bash```
    -v "$(pwd)/src/dags":/lessons/dags \
  ```

  Данные закачались, распределились по слоям. Ничто так не радует, как зелёный цвет в Airflow 

  ## 3. Использование данных

  STAGING + DWH заполнены, далее строим графики. Финансовые расчёты – в валюте **420**.
  Поскольку amounts лежат в целочисленной сумме транзакции в минимальной единице валюты страны – делим на 100.


  ## 3.1 Общий оборот 

  Если долго смотреть на показатель общего оборота (**1,224,229,981.6** у.е.), он выглядит внушительно.
  При этом валюта **430** тащит половину общей суммы. А если отсмотреть отдельно данные таблицы **currencies**, выясняется интересное: у 430 курс пересчёта в основную валюту занижен — всего 0.93, в то время как у других доходит до 1.07.
  То есть каждая транзакция в 430 весит меньше в итоговом обороте, чем транзакция в других валютах.

  И тут становится особенно интересно — почему люди массово используют валюту, у которой курс хуже?

  Моя гипотеза из практики: это может быть не про курс, а про удобство, доступность и отсутствие альтернатив.
  Когда-то я видела, как российский финтех стартап (с британскими корнями и инвестициями) продавал евро при переводах в Сербию за 110 рублей при курсе ЦБ 98 — просто потому что другого способа для бизнеса обменять деньги и не быть в минусе нет. Да, курс ужасный, но шлюз работает. Люди платят за надёжный выход.

  Шлюзы — это не просто API. Это договоры, комплаенс, банки-партнёры. Любая новая валюта — это расходы на запуск и сопровождение канала. Поэтому продукт может осознанно не гнаться за мультивалютностью.

  И самое важное, оборот — это не доход.
  Без данных по комиссиям и чистой прибыли мы не поймём, может ли продукт жить на то, что зарабатывает, или просто красиво качает чужие деньги из одной страны в другую.

  Резюмируя, выгода — это не всегда цифры. Это также доступность, скорость, надёжность и «чтобы завтра не закрыли счёт».

  ## Среднее количество транзакций на пользователя 

  Внушительный всплеск в начале октября и далее – плоская линия. Если паралелльно смотреть на оборот в этот день (на уровне средней линии), то возникают вопросы, а всё ли в порядке было в этот день? Возможно, сбой именно в эту дату. Либо сбой был в остальные дни – так как количество транзакций на пользователя в остальные дни около 1, либо их вообще не было – и траназкции прошли как «всё отвисло».

  Я надеюсь, этот продукт не основной для финтеха, на данные которого я смотрю. На мой взгляд, с такой нестабильностью сложно генерировать стабильные деньги. 

  ## Количество уникальных пользователей
  Валюта **430** и здесь тащит. При этом про её курс я уже писала выше.

  Вывод пока такой: это не мультивалютный продукт. Возможно, продукт оказался в нужное время в нужном месте.

  ## Оборот транзакций по дням

  Кажется, по этому графику можно определить, когда пользователи получают зарплату и выводят её в другие страны. 8.10.2022 – суббота после расчётного дня. В этот выходной день транзачили 1797 уникальных пользователей и почти каждый пользователь сделал одну транзакцию. 

  Если связывать с геополитикой, я вижу (и снова её чувствую) панику в РФ в эти даты. За 2 недели до этого объявили мобилизацию. Вслед за ней многие умы и капиталы массово перетекли в соседние страны. Возможность обменять рубли на другие дружественные и недружественные валюты в тот момент было востребовано, что и отразилось на данных нашего стартапчика. Кстати, а доллары и евро тогда можно было купить примерно за 65-70 рублей. Лично я на тот момент много проинвестировала в валюту – и через несколько месяцев сказала себе «спасибо».

  Если вкратце резюмировать: продукт не стабильный, он реактивный. Живёт всплесками и за счёт одной валюты.

  Спасибо за ревью. Буду ждать обратную связь 